{%extends 'base.html' %}
{% load static %}

{% block title %}Ficha del Vehículo{% endblock %}

{% block content %}

<h2 class="fw-bold mb-4" style="color:#002855;">
  {{ vehiculo.marca }} {{ vehiculo.modelo }} — {{ vehiculo.dominio|default:"Sin dominio" }}
</h2>

<div class="mb-4 d-flex" style="gap: 15px;">
  <a href="/vehiculos/" class="btn btn-secondary rounded-3">Volver al stock</a>
  <a href="/vehiculos/pdf/{{ vehiculo.id }}/" class="btn btn-warning rounded-3">Descargar PDF</a>

  {% if vehiculo.estado == "vendido" and request.GET.from != "cuenta" %}
    <a href="/ventas/" class="btn btn-primary rounded-3">
      Ir a Ventas
    </a>
  {% endif %}

  {% if vehiculo.venta and vehiculo.venta.cuenta_corriente %}
    <a href="{% url 'cuentas:cuenta_corriente_detalle' vehiculo.venta.cuenta_corriente.id %}"
       class="btn btn-outline-secondary rounded-3">
      Volver a Cuenta Corriente
    </a>
  {% endif %}
</div>

{% if vehiculo.estado == "vendido" %}
<div class="alert alert-warning rounded-4 mb-4">
  <strong>Unidad vendida.</strong><br>

  {% if vehiculo.venta %}
    Cliente asignado: <strong>{{ vehiculo.venta.cliente.nombre_completo }}</strong><br>
    Estado de la venta: <span class="badge bg-success">Confirmada</span>
  {% else %}
    <span class="text-danger fw-bold">
      Falta asignar cliente para completar la venta.
    </span>
  {% endif %}
</div>
{% endif %}

<!-- ========================================================= -->
<!-- DATOS BASICOS DEL VEHICULO -->
<!-- ========================================================= -->
<div class="card shadow-sm rounded-4 p-4 mb-4">

  <h4 class="fw-bold mb-3" style="color:#002855;">Datos del Vehículo</h4>

  <div class="row g-3">

      <div class="col-md-4">
        <label class="fw-bold">Marca</label>
        <div>{{ vehiculo.marca }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Modelo</label>
        <div>{{ vehiculo.modelo }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Dominio</label>
        <div>{{ vehiculo.dominio }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Año</label>
        <div>{{ vehiculo.anio }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Kilómetros</label>
        <div>{{ vehiculo.kilometros|default:"No informado" }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Estado</label>
        <div>{{ vehiculo.get_estado_display }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Precio</label>
        <div>${{ vehiculo.precio|default:0 }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Número motor</label>
        <div>{{ ficha.numero_motor|default:"No informado" }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Número chasis</label>
        <div>{{ ficha.numero_chasis|default:"No informado" }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Fecha inscripción inicial</label>
        <div>
          {% if ficha.fecha_inscripcion_inicial %}
            {{ ficha.fecha_inscripcion_inicial|date:"d/m/Y" }}
          {% else %}
            No informado
          {% endif %}
        </div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Color</label>
        <div>{{ ficha.color|default:"No informado" }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Combustible</label>
        <div>{{ ficha.combustible|default:"No informado" }}</div>
      </div>

      <div class="col-md-4">
        <label class="fw-bold">Transmisión</label>
        <div>{{ ficha.transmision|default:"No informado" }}</div>
      </div>

  </div>
</div>

<!-- ========================================================= -->
<!-- TITULARIDAD (EDITABLE) -->
<!-- ========================================================= -->
<div class="card shadow-sm rounded-4 p-4 mb-4">

  <form method="post" action="{% url 'vehiculos:guardar_ficha_parcial' vehiculo.id %}">
    {% csrf_token %}

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="fw-bold mb-0" style="color:#002855;">Titularidad e Ingreso</h4>
      <button type="submit" class="btn btn-primary btn-sm fw-bold">Guardar cambios</button>
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="fw-bold">Vendedor</label>
        {{ ficha_form.vendedor }}
      </div>
      <div class="col-md-6">
        <label class="fw-bold">Contacto</label>
        {{ ficha_form.contacto }}
      </div>
      <div class="col-md-6">
        <label class="fw-bold">Email contacto</label>
        {{ ficha_form.email_contacto }}
      </div>
      <div class="col-md-6">
        <label class="fw-bold">Titular</label>
        {{ ficha_form.titular }}
      </div>
      <div class="col-md-4">
        <label class="fw-bold">Domicilio titular</label>
        {{ ficha_form.domicilio_titular }}
      </div>
      <div class="col-md-4">
        <label class="fw-bold">DNI titular</label>
        {{ ficha_form.dni_titular }}
      </div>
      <div class="col-md-4">
        <label class="fw-bold">Estado civil</label>
        {{ ficha_form.estado_civil }}
      </div>
      <div class="col-md-4">
        <label class="fw-bold">CUIT / CUIL / DNI</label>
        {{ ficha_form.cuit_cuil_dni }}
      </div>
      <div class="col-md-4">
        <label class="fw-bold">Tipo ingreso</label>
        {{ ficha_form.tipo_ingreso }}
      </div>
      <div class="col-md-4">
        <label class="fw-bold">N° consignación / factura</label>
        {{ ficha_form.numero_consignacion_factura }}
      </div>
    </div>

  </form>
</div>

<!-- ========================================================= -->
<!-- DOCUMENTACIÓN (EDITABLE) -->
<!-- ========================================================= -->
<div class="card shadow-sm rounded-4 p-4 mb-4">

  <form method="post" action="{% url 'vehiculos:guardar_ficha_parcial' vehiculo.id %}">
    {% csrf_token %}

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="fw-bold mb-0" style="color:#002855;">Documentación</h4>
      <button type="submit" class="btn btn-primary btn-sm fw-bold">Guardar cambios</button>
    </div>

    <div class="row g-3">
      <div class="col-md-3">
        <label class="fw-bold">Patentes - Estado</label>
        {{ ficha_form.patentes_estado }}
      </div>
      <div class="col-md-3">
        <label class="fw-bold">Monto deuda</label>
        {{ ficha_form.patentes_monto }}
      </div>
      <div class="col-md-3">
        <label class="fw-bold">Vencimiento 1</label>
        {{ ficha_form.patentes_vto1 }}
      </div>
      <div class="col-md-3">
        <label class="fw-bold">Vencimiento 2</label>
        {{ ficha_form.patentes_vto2 }}
      </div>
      <div class="col-md-3">
        <label class="fw-bold">Vencimiento 3</label>
        {{ ficha_form.patentes_vto3 }}
      </div>
      <div class="col-md-3">
        <label class="fw-bold">Vencimiento 4</label>
        {{ ficha_form.patentes_vto4 }}
      </div>
      <div class="col-md-3">
        <label class="fw-bold">Vencimiento 5</label>
        {{ ficha_form.patentes_vto5 }}
      </div>
    </div>

    <hr class="my-4">

    <div class="row g-3">
      <div class="col-md-3">
        <label class="fw-bold">Formulario 08</label>
        {{ ficha_form.f08_estado }}
      </div>
      <div class="col-md-3">
        <label class="fw-bold">Cédula</label>
        {{ ficha_form.cedula_estado }}
      </div>
    </div>

    <hr class="my-4">

    <div class="row g-3">
      <div class="col-md-3">
        <label class="fw-bold">Verificación policial</label>
        {{ ficha_form.verificacion_estado }}
      </div>
      <div class="col-md-3">
        <label class="fw-bold">Vencimiento</label>
        {{ ficha_form.verificacion_vencimiento }}
      </div>
    </div>

    <hr class="my-4">

    <div class="row g-3">
      <div class="col-md-3">
        <label class="fw-bold">Grabado de autopartes</label>
        {{ ficha_form.autopartes_estado }}
      </div>
    </div>

    <hr class="my-4">

    <div class="row g-3">
      <div class="col-md-3">
        <label class="fw-bold">VTV</label>
        {{ ficha_form.vtv_estado }}
      </div>
      <div class="col-md-3">
        <label class="fw-bold">Vencimiento</label>
        {{ ficha_form.vtv_vencimiento }}
      </div>
    </div>

  </form>
</div>

<!-- ========================================================= -->
<!-- GASTOS DE INGRESO -->
<!-- ========================================================= -->
<div class="card shadow-sm rounded-4 p-4 mb-4">

  <h4 class="fw-bold mb-3" style="color:#002855;">Gastos de ingreso</h4>

  <div class="row g-3">

    <!-- TOTAL -->
    <div class="col-12 mb-2">
      <label class="fw-bold">Total gastos</label>
      <div>
        {% if ficha.total_gastos %}
          ${{ ficha.total_gastos }}
        {% else %}
          No informado
        {% endif %}
      </div>
    </div>

    <!-- DETALLE DE GASTOS -->
    <div class="col-md-3">
      <label class="fw-bold">Formulario 08</label>
      <div>${{ ficha.gasto_f08|default:0 }}</div>
    </div>

    <div class="col-md-3">
      <label class="fw-bold">Informes</label>
      <div>${{ ficha.gasto_informes|default:0 }}</div>
    </div>

    <div class="col-md-3">
      <label class="fw-bold">Patentes</label>
      <div>${{ ficha.gasto_patentes|default:0 }}</div>
    </div>

    <div class="col-md-3">
      <label class="fw-bold">Infracciones</label>
      <div>${{ ficha.gasto_infracciones|default:0 }}</div>
    </div>

    <div class="col-md-3">
      <label class="fw-bold">Verificación</label>
      <div>${{ ficha.gasto_verificacion|default:0 }}</div>
    </div>

    <div class="col-md-3">
      <label class="fw-bold">Autopartes</label>
      <div>${{ ficha.gasto_autopartes|default:0 }}</div>
    </div>

    <div class="col-md-3">
      <label class="fw-bold">VTV</label>
      <div>${{ ficha.gasto_vtv|default:0 }}</div>
    </div>

    <div class="col-md-3">
      <label class="fw-bold">R-541</label>
      <div>${{ ficha.gasto_r541|default:0 }}</div>
    </div>

    <div class="col-md-3">
      <label class="fw-bold">Firmas</label>
      <div>${{ ficha.gasto_firmas|default:0 }}</div>
    </div>

  </div>

</div>

<!-- ========================================================= -->
<!-- PAGO DE GASTOS -->
<!-- ========================================================= -->
<div class="card shadow-sm rounded-4 p-4 mb-4">
  <h4 class="fw-bold mb-3" style="color:#002855;">Pago de gastos de ingreso</h4>

  {% for gasto in gastos_ingreso %}
  <div class="border rounded-3 p-3 mb-3 {% if gasto.esta_pagado %}bg-light{% endif %}">
    <div class="fw-bold mb-2 d-flex justify-content-between align-items-center">
      <span>{{ gasto.concepto }} — ${{ gasto.monto }}</span>
      {% if gasto.esta_pagado %}
      <span class="badge bg-success">PAGADO</span>
      {% endif %}
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="fw-bold">Total pagado</label>
        <div>${{ gasto.total_pagado }}</div>
      </div>
      <div class="col-md-4">
        <label class="fw-bold">Saldo</label>
        <div class="{% if gasto.saldo > 0 %}text-danger{% else %}text-success{% endif %}">
          ${{ gasto.saldo }}
        </div>
      </div>
    </div>

    <!-- HISTORIAL DE PAGOS -->
    {% if gasto.pagos %}
    <div class="mb-3">
      <label class="fw-bold text-muted">Historial de pagos:</label>
      <div class="table-responsive">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>Fecha</th>
              <th class="text-end">Monto</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody>
            {% for pago in gasto.pagos %}
            <tr>
              <td>{{ pago.fecha_pago|date:"d/m/Y" }}</td>
              <td class="text-end">${{ pago.monto }}</td>
              <td>{{ pago.observaciones|default:"-" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- FORMULARIO PARA NUEVO PAGO (solo si no está pagado) -->
    {% if not gasto.esta_pagado %}
    <form method="post" action="{% url 'vehiculos:registrar_pago_gasto' %}">
      {% csrf_token %}
      <input type="hidden" name="vehiculo_id" value="{{ vehiculo.id }}">
      <input type="hidden" name="gasto_id" value="{{ gasto.key }}">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="fw-bold">Fecha de pago</label>
          <input type="date" name="fecha_pago" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="fw-bold">Monto</label>
          <input type="number" step="0.01" name="monto" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="fw-bold">Observaciones</label>
          <input type="text" name="observaciones" class="form-control">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            Registrar pago
          </button>
        </div>
      </div>
    </form>
    {% endif %}

  </div>
  {% empty %}
  <p class="text-muted">No hay gastos de ingreso cargados.</p>
  {% endfor %}

  <hr class="my-4">
  <div class="d-flex justify-content-end">
    <div class="text-end">
      <div class="fw-bold text-muted">
        Total pendiente de gastos
      </div>
      <div class="fs-4 fw-bold
        {% if total_pendiente > 0 %}
          text-danger
        {% else %}
          text-success
        {% endif %}
      ">
        ${{ total_pendiente|default:"0" }}
      </div>
    </div>
  </div>
</div>

<!-- ========================================================= -->
<!-- OBSERVACIONES -->
<!-- ========================================================= -->
<div class="card shadow-sm rounded-4 p-4 mb-4">

  <h4 class="fw-bold mb-3" style="color:#002855;">Observaciones</h4>

  <p>{{ ficha.observaciones|default_if_none:"No hay observaciones cargadas"|linebreaks }}</p>

</div>

{% endblock %}