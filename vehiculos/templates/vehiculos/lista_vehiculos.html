{% extends 'base.html' %}
{% load static %}

{% block title %}Stock de Vehículos{% endblock %}

{% block content %}

<h2 class="fw-bold" style="color:#002855;">Stock de Vehículos</h2>

<!-- BUSCADOR -->
<form method="GET" class="mb-3 d-flex" style="gap: 10px;">
    <input type="text"
           name="q"
           class="form-control"
           placeholder="Buscar por marca, modelo o dominio..."
           value="{{ query|default:'' }}">
    <button class="btn btn-primary">Buscar</button>
</form>

<!-- BOTONES SUPERIORES -->
<div class="d-flex mb-3" style="gap:10px;">
    <a href="/vehiculos/agregar/" class="btn btn-dark fw-bold">
        Agregar Vehículo
    </a>

    <a href="/vehiculos/gastos/" class="btn btn-warning fw-bold">
        Gastos
    </a>
</div>

<!-- TABLA -->
<div class="card shadow-sm rounded-4">
    <div class="card-body p-0">

        <table class="table table-striped mb-0 align-middle">
            <thead style="background:#002855; color: white;">
                <tr>
                    <th style="width:120px;">Acción</th>
                    <th>Carpeta</th>
                    <th>Marca</th>
                    <th>Modelo</th>
                    <th>Dominio</th>
                    <th>Año</th>
                    <th>Kilómetros</th>
                    <th>Precio</th>
                    <th style="width:260px;">Estado</th>
                </tr>
            </thead>

            <tbody>

                {% for v in vehiculos %}
                <tr>

                    <!-- ACCIONES -->
                    <td>
                        <div class="d-flex flex-column" style="gap:6px;">

                            <!-- MAS INFO -->
                            <button type="button"
                                    class="btn btn-warning fw-bold btn-sm"
                                    onclick="abrirFicha('{{ v.id }}')">
                                Más info
                            </button>
{% if v.puede_eliminarse %}
<form method="POST"
      action="{% url 'vehiculos:eliminar_vehiculo' v.id %}"
      onsubmit="return confirm('¿Seguro que querés eliminar este vehículo? Esta acción no se puede deshacer.');">
    {% csrf_token %}
    <button type="submit"
            class="btn btn-sm"
            style="border:1px solid #dc3545; color:#dc3545;">
        Eliminar
    </button>
</form>
{% else %}
<span class="badge bg-secondary">
    No eliminable
</span>
{% endif %}


                    <!-- NUMERO DE CARPETA -->
                    <td>
                        {{ v.numero_carpeta|default:"–" }}
                    </td>

                    <td>{{ v.marca|default:"–" }}</td>
                    <td>{{ v.modelo|default:"–" }}</td>
                    <td>{{ v.dominio|default:"–" }}</td>
                    <td>{{ v.anio }}</td>

                    <td>
                        {{ v.kilometros|default:"No informado" }}
                    </td>

                    <td>
                        $ {{ v.precio|default:0|floatformat:0 }}
                    </td>

                    <!-- ESTADO EDITABLE + BADGE -->
                    <td>
                        <div class="d-flex align-items-center" style="gap:6px;">

                            <form method="POST"
                                  action="{% url 'vehiculos:cambiar_estado_vehiculo' v.id %}"
                                  class="d-flex align-items-center"
                                  style="gap:6px;">
                                {% csrf_token %}

                                <select name="estado"
                                        class="form-select form-select-sm">
                                    <option value="stock"
                                            {% if v.estado == 'stock' %}selected{% endif %}>
                                        En stock
                                    </option>

                                    <option value="temporal"
                                            {% if v.estado == 'temporal' %}selected{% endif %}>
                                        Temporalmente no disponible
                                    </option>

                                    <option value="vendido"
                                            {% if v.estado == 'vendido' %}selected{% endif %}>
                                        Vendido
                                    </option>
                                </select>

                                <button type="submit"
                                        class="btn btn-sm btn-outline-primary">
                                    Guardar
                                </button>
                            </form>

                            {% if v.estado == "stock" %}
                                <span class="badge bg-success">Stock</span>
                            {% elif v.estado == "temporal" %}
                                <span class="badge bg-warning text-dark">Temporal</span>
                            {% elif v.estado == "vendido" %}
                                <span class="badge bg-danger">Vendido</span>
                            {% endif %}

                            {% if v.estado == "vendido" and not v.venta %}
                                <span class="badge bg-danger">
                                    Venta pendiente
                                </span>
                            {% endif %}

                        </div>
                    </td>

                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center py-4 text-muted">
                        No hay vehículos cargados.
                    </td>
                </tr>
                {% endfor %}

            </tbody>
        </table>

    </div>
</div>

<!-- CONTENEDOR MODAL -->
<div id="modalFichaContainer"></div>

<script>
function abrirFicha(id) {
    var url = "/vehiculos/ficha-vehicular/" + id + "/";

    fetch(url)
        .then(function(response) {
            if (!response.ok) {
                console.log("Error en la respuesta de la ficha vehicular. Código:", response.status);
                alert("No se pudo cargar la ficha del vehículo. Código " + response.status);
                return null;
            }
            return response.json();
        })
        .then(function(data) {
            if (!data) {
                return;
            }

            if (!data.html) {
                console.log("La respuesta no contiene 'html':", data);
                alert("La respuesta del servidor no es la esperada.");
                return;
            }

            var contenedor = document.getElementById("modalFichaContainer");
            contenedor.innerHTML = data.html;

            var modalElement = document.getElementById("modalFicha");
            if (!modalElement) {
                console.log("No se encontró el elemento con id 'modalFicha' en el HTML inyectado.");
                alert("No se pudo abrir el detalle del vehículo.");
                return;
            }

            var modal = new bootstrap.Modal(modalElement);
            modal.show();
        })
        .catch(function(error) {
            console.log("Error en fetch de ficha vehicular:", error);
            alert("Ocurrió un error al cargar la ficha del vehículo.");
        });
}
</script>

{% endblock %}
