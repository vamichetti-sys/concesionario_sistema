{% extends "base.html" %}

{% block title %}Calendario{% endblock %}

{% block content %}

<div class="card-clean">
    <h3 class="mb-2">Calendario de vencimientos y turnos</h3>
    <p class="text-muted mb-3">
        Vencimientos de documentaci√≥n y turnos programados por veh√≠culo.
    </p>

    <!-- ===============================
         ACCIONES
    =============================== -->
    <div class="d-flex justify-content-end mb-3">
        <button
            id="btnPdfMes"
            class="btn btn-outline-primary btn-sm">
            üìÑ Exportar PDF del mes
        </button>
    </div>

    <!-- üÜï LEYENDA ACTUALIZADA -->
    <div class="d-flex flex-wrap gap-3 mb-3 small">
        <div class="d-flex align-items-center gap-2">
            <span style="width:14px; height:14px; background:#dc3545; display:inline-block; border-radius:3px;"></span>
            Vencimiento VTV
        </div>
        <div class="d-flex align-items-center gap-2">
            <span style="width:14px; height:14px; background:#fd7e14; display:inline-block; border-radius:3px;"></span>
            Vencimiento Verificaci√≥n
        </div>
        <div class="d-flex align-items-center gap-2">
            <span style="width:14px; height:14px; background:#ffc107; display:inline-block; border-radius:3px;"></span>
            Vencimiento Patentes
        </div>
        <div class="d-flex align-items-center gap-2">
            <span style="width:14px; height:14px; background:#0dcaf0; display:inline-block; border-radius:3px;"></span>
            Turnos
        </div>
    </div>

    <div id="calendar"></div>
</div>

<!-- ===============================
     FULLCALENDAR
=============================== -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<!-- ===============================
     IDENTIDAD VISUAL AMICHETTI
=============================== -->
<style>
.fc {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
}

.fc-toolbar-title {
    font-weight: 700;
    color: #002855;
}

.fc-button {
    background: #002855 !important;
    border: none !important;
    box-shadow: none !important;
}

.fc-button:hover {
    background: #001c3d !important;
}

.fc-button-primary:not(:disabled).fc-button-active {
    background: #FF6C1A !important;
}

/* EVENTOS */
.fc-event {
    border: none !important;
    border-radius: 6px !important;
    padding: 3px 6px !important;
    font-size: 0.75rem;
    cursor: pointer;
    color: #ffffff !important;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0,0,0,.35);
}

/* üÜï COLORES POR TIPO */
.fc-event[style*="#dc3545"] {
    background-color: #dc3545 !important;
}

.fc-event[style*="#fd7e14"] {
    background-color: #fd7e14 !important;
}

.fc-event[style*="#ffc107"] {
    background-color: #ffc107 !important;
    color: #2b2b2b !important;
    text-shadow: none;
}

.fc-event[style*="#0dcaf0"] {
    background-color: #0dcaf0 !important;
    color: #2b2b2b !important;
    text-shadow: none;
}

.fc-day-today {
    background: #fff7e6 !important;
}

.fc-daygrid-event {
    margin-top: 4px;
}

/* üÜï HOVER */
.fc-event:hover {
    opacity: 0.85;
    transform: scale(1.02);
    transition: all 0.2s ease;
}
</style>

<script>
/* ======================================================
   üîí FIX DEFINITIVO DUPLICADO
   NO SE TOCA NADA M√ÅS
   ====================================================== */
if (!window.__calendarInitialized) {
    window.__calendarInitialized = true;

    document.addEventListener('DOMContentLoaded', function () {

        let calendarEl = document.getElementById('calendar');
        let btnPdf = document.getElementById('btnPdfMes');

        let calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            height: 'auto',

            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },

            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                list: 'Lista'
            },

            buttonIcons: false,

            /* ===============================
               API EVENTOS
            =============================== */
            events: "/calendario/api/eventos/",

            /* üÜï RENDERIZADO MEJORADO */
            eventDidMount: function(info) {
                let titulo = info.event.title;

                // Limpiar prefijos para mostrar solo lo importante
                titulo = titulo
                    .replace("Vencimiento VTV ‚Äì ", "VTV ¬∑ ")
                    .replace("Vencimiento Verificaci√≥n ‚Äì ", "Verificaci√≥n ¬∑ ")
                    .replace("Vencimiento Patente ‚Äì ", "Patente ¬∑ ")
                    .replace("Turno VTV ‚Äì ", "Turno VTV ¬∑ ")
                    .replace("Turno grabado autopartes ‚Äì ", "Autopartes ¬∑ ");

                info.el.innerHTML = `
                    <div class="fc-event-title fw-semibold small">
                        ${titulo}
                    </div>
                `;
                
                // üÜï AGREGAR TOOLTIP CON INFO DEL VEH√çCULO
                if (info.event.extendedProps.vehiculo_info) {
                    info.el.title = info.event.extendedProps.vehiculo_info;
                }
            },

            /* üÜï CLICK EN EVENTO - IR A LA FICHA */
            eventClick: function(info) {
                // Si tiene URL, ir a la ficha del veh√≠culo
                if (info.event.extendedProps.url) {
                    window.location.href = info.event.extendedProps.url;
                    info.jsEvent.preventDefault();
                }
            }
        });

        calendar.render();

        // ===============================
        // PDF DEL MES VISIBLE
        // ===============================
        btnPdf.addEventListener("click", function () {
            let fecha = calendar.getDate();
            let mes = fecha.getMonth() + 1;
            let anio = fecha.getFullYear();

            let url = `/calendario/pdf/${anio}/${mes}/`;
            window.open(url, "_blank");
        });
    });
}
</script>

{% endblock %}